<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ—ãƒ©ãƒãƒŠå“ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆé–²è¦§å°‚ç”¨ï¼‰</title>
  <link rel="icon" href="ã‚¢ã‚¤ã‚³ãƒ³.png" type="image/png">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    /* é–²è¦§å°‚ç”¨ã®è¦‹ãŸç›®ã¡ã‚‡ã„è¶³ã—ï¼ˆä»»æ„ï¼‰ */
    .readonly-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.08);
    }
    .guest-card{ cursor: default; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div id="headerStatus" class="header-status"></div>
      </div>

      <div class="controls">
        <button class="btn ghost" id="btnPrev">â—€ å‰æ—¥</button>
        <div class="field" title="å–¶æ¥­æ—¥">
          <input type="date" id="datePicker" />
        </div>
        <button class="btn ghost" id="btnNext">ç¿Œæ—¥ â–¶</button>
        <button class="btn ghost" id="btnToday">ä»Šæ—¥</button>
        <span class="readonly-badge">ğŸ‘€ é–²è¦§å°‚ç”¨</span>
      </div>
    </header>

    <div class="grid">
      <section class="floor">
        <div class="seat-grid">
          <div class="zone box2" data-seat="BOX2">
            <div class="zone-title">BOX2</div>
            <div class="drop" id="seat-BOX2"></div>
          </div>

          <div class="zone box3" data-seat="BOX3">
            <div class="zone-title">BOX3</div>
            <div class="drop" id="seat-BOX3"></div>
          </div>

          <div class="zone box1" data-seat="BOX1">
            <div class="zone-title">BOX1</div>
            <div class="drop" id="seat-BOX1"></div>
          </div>

          <div class="counter-row">
            <div class="zone counter" data-seat="C1"><div class="zone-title">C1</div><div class="drop" id="seat-C1"></div></div>
            <div class="zone counter" data-seat="C2"><div class="zone-title">C2</div><div class="drop" id="seat-C2"></div></div>
            <div class="zone counter" data-seat="C3"><div class="zone-title">C3</div><div class="drop" id="seat-C3"></div></div>
            <div class="zone counter" data-seat="C4"><div class="zone-title">C4</div><div class="drop" id="seat-C4"></div></div>
            <div class="zone counter" data-seat="C5"><div class="zone-title">C5</div><div class="drop" id="seat-C5"></div></div>
            <div class="zone counter" data-seat="C6"><div class="zone-title">C6</div><div class="drop" id="seat-C6"></div></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div class="ttl">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆå—ä»˜è¡¨ï¼‰</div>
          <div class="right">
            <input class="search" id="search" placeholder="åå‰æ¤œç´¢ï¼ˆä¾‹ï¼šä½è—¤ï¼‰" />
            <button class="btn ghost" id="btnSortEnd">çµ‚äº†æ™‚é–“é †</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>No</th><th>ç´¯è¨ˆ</th><th>å“ç•ª</th><th>åŒºåˆ†</th><th>ãŠå®¢æ§˜å</th>
                <th>äººæ•°</th><th>å…¥åº—</th><th>é€€åº—</th><th>å»¶é•·</th><th>çŠ¶æ…‹</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      const SEATS = ["BOX1","BOX2","BOX3","C1","C2","C3","C4","C5","C6"];
      const BASE_MIN = 90;
      const API_URL = "/api";

      const pad2 = (n) => String(n).padStart(2, "0");
      const toHHMM = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      const addMinutes = (date, min) => { const d = new Date(date); d.setMinutes(d.getMinutes()+min); return d; };

      const roundDown5Min = (date) => {
        const d = new Date(date);
        d.setMinutes(Math.floor(d.getMinutes()/5)*5, 0, 0);
        return d;
      };

      // 7:00ã‚ˆã‚Šå‰ã¯ â€œå‰æ—¥å–¶æ¥­æ—¥â€
      const businessDateFor = (date) => {
        const d = new Date(date);
        const biz = new Date(d);
        if (biz.getHours() < 7) biz.setDate(biz.getDate() - 1);
        return `${biz.getFullYear()}-${pad2(biz.getMonth()+1)}-${pad2(biz.getDate())}`;
      };

      const isBoxSeat = (seat) => /^BOX[123]$/.test(String(seat || ""));
      const isCounterSeat = (seat) => /^C[1-6]$/.test(String(seat || ""));
      const escapeHtml = (str) => String(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");

      const totalExtMin = (g) => (g.extends || []).reduce((a, e) => a + (Number(e.min) || 0), 0);
      const dueAt = (g) => addMinutes(new Date(g.checkInAt), BASE_MIN + totalExtMin(g));
      const remainingMin = (g, now) => Math.floor((dueAt(g) - now) / 60000);

      const guestTypeKey = (g) => {
        const v = g?.guestType ?? g?.type ?? g?.customerType ?? g?.kbn ?? "unknown";
        const s = String(v ?? "").trim().toLowerCase();
        return s || "unknown";
      };
      const guestTypeLabel = (g) => {
        const s = guestTypeKey(g);
        if (["new","æ–°è¦","shinki","first","åˆå›","0"].includes(s)) return "æ–°è¦";
        if (["repeat","repeater","ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼","ãƒªãƒ”","1"].includes(s)) return "ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼";
        return "ä¸æ˜";
      };
      const typeShort = (g) => {
        const t = guestTypeKey(g);
        if (t === "new") return "æ–°è¦";
        if (t === "repeat" || t === "repeater") return "ãƒªãƒ”";
        return "ä¸æ˜";
      };

      const normalizeGroup = (g) => {
        if (!g.primarySeat) g.primarySeat = g.seatId || "BOX1";
        if (!Array.isArray(g.occupiedSeats)) g.occupiedSeats = [g.primarySeat];
        if (g.primarySeat && !g.occupiedSeats.includes(g.primarySeat)) g.occupiedSeats.unshift(g.primarySeat);
        g.name = (g.name ?? "");
        g.partySize = Number(g.partySize ?? 1);
        g.note = (g.note ?? "");
        if (!Array.isArray(g.extends)) g.extends = [];
        if (!Array.isArray(g.moves)) g.moves = [];
        g.checkOutAt = g.checkOutAt || null;
        g.ticketNo = Number(g.ticketNo || 0);
        return g;
      };

      async function apiGetDay(bizDate){
        const url = `${API_URL}?action=day&bizDate=${encodeURIComponent(bizDate)}`;
        const res = await fetch(url, { method:"GET" });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "api error");
        return Array.isArray(json.groups) ? json.groups : [];
      }

      const storageKey = (bizDate) => `platinum_ro_day_${bizDate}`;

      async function loadDay(bizDate){
        try{
          const data = await apiGetDay(bizDate);
          localStorage.setItem(storageKey(bizDate), JSON.stringify(data)); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘
          return data;
        }catch{
          const raw = localStorage.getItem(storageKey(bizDate));
          if (!raw) return [];
          try { const data = JSON.parse(raw); return Array.isArray(data) ? data : []; }
          catch { return []; }
        }
      }

      const datePicker = document.getElementById("datePicker");
      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const btnToday = document.getElementById("btnToday");
      const headerStatus = document.getElementById("headerStatus");
      const tbody = document.getElementById("tbody");
      const search = document.getElementById("search");
      const btnSortEnd = document.getElementById("btnSortEnd");

      let currentBizDate = businessDateFor(new Date());
      let groups = [];
      let sortByEnd = false;

      const addDaysToBizDate = (bizDate, delta) => {
        const d = new Date(bizDate + "T00:00:00");
        d.setDate(d.getDate() + delta);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      };

      const displayNameOf = (g) => {
        const nm = (g.name || "").trim();
        return nm ? nm : `No.${Number(g.ticketNo)||""}`;
      };

      const createCard = (g) => {
        const seat = g.primarySeat || g.seatId || "";
        const isBox = isBoxSeat(seat);
        const isCounter = isCounterSeat(seat);

        const card = document.createElement("div");
        card.dataset.id = g.id;

        const now = new Date();
        const inT = toHHMM(new Date(g.checkInAt));
        const dueT = toHHMM(dueAt(g));
        const rem = remainingMin(g, now);

        const displayName = displayNameOf(g);
        const remText = (rem >= 0) ? `æ®‹${rem}åˆ†` : `è¶…é${Math.abs(rem)}åˆ†`;
        const typeText = typeShort(g);

        card.className = "guest-card";
        if (isBox) card.classList.add("is-box");
        if (isCounter) card.classList.add("is-counter");
        if (rem < 0) card.classList.add("is-over");
        else if (rem <= 15) card.classList.add("is-soon");

        card.innerHTML = `
          <div class="card-head">
            <div class="card-dots">â— â— â—</div>
            <div class="card-x">Ã—</div>
          </div>
          <div class="card-body">
            ${
              isBox
                ? `
                  <div class="box-no">${escapeHtml(displayName)}</div>
                  <div class="box-time">${inT} - ${dueT}</div>
                  <div class="box-rem">${escapeHtml(remText)}</div>
                  <div class="box-meta">${escapeHtml(typeText)} / ${Number(g.partySize||0)}å</div>
                `
                : `
                  <div class="gc-name">${escapeHtml(displayName)}</div>
                  <div class="gc-rem">${escapeHtml(remText)}</div>
                  <div class="gc-time">${inT} - ${dueT}</div>
                  <div class="gc-meta">${escapeHtml(typeText)} / ${Number(g.partySize||0)}å</div>
                `
            }
          </div>
        `;
        return card;
      };

      const createStamp = (g) => {
        const st = document.createElement("div");
        st.className = "seat-stamp";
        const nm = displayNameOf(g);
        st.innerHTML = `ğŸ“Œ ${escapeHtml(nm)} <small>${Number(g.partySize||0)}å</small>`;
        return st;
      };

      const applySingleCardClass = () => {
        ["BOX1","BOX2"].forEach(seat => {
          const drop = document.getElementById(`seat-${seat}`);
          if (!drop) return;
          const cards = drop.querySelectorAll(":scope > .guest-card");
          drop.classList.toggle("single-card", cards.length === 1);
        });
      };

      const renderSeats = () => {
        for (const seat of SEATS){
          const drop = document.getElementById(`seat-${seat}`);
          if (drop) drop.innerHTML = "";
        }

        const staying = groups.filter((g) => !g.checkOutAt);

        for (const g of staying){
          const p = g.primarySeat || g.seatId;

          if (p){
            const drop = document.getElementById(`seat-${p}`);
            if (drop) drop.appendChild(createCard(g));
          }

          const occ = Array.isArray(g.occupiedSeats) ? g.occupiedSeats : [];
          for (const s of occ){
            if (!s || s === p) continue;
            const drop = document.getElementById(`seat-${s}`);
            if (drop) drop.appendChild(createStamp(g));
          }
        }
        applySingleCardClass();
      };

      const endTimeMs = (g) => (g.checkOutAt ? new Date(g.checkOutAt) : dueAt(g)).getTime();

      const renderTable = () => {
        const q = (search.value || "").trim().toLowerCase();

        const sorted = [...groups].sort((a, b) => {
          const aNo = Number(a.ticketNo);
          const bNo = Number(b.ticketNo);
          const aKey = Number.isFinite(aNo) && aNo > 0 ? aNo : 999999;
          const bKey = Number.isFinite(bNo) && bNo > 0 ? bNo : 999999;

          if (sortByEnd){
            const ad = a.checkOutAt ? 1 : 0;
            const bd = b.checkOutAt ? 1 : 0;
            if (ad !== bd) return ad - bd;

            if (!a.checkOutAt && !b.checkOutAt){
              const t = endTimeMs(a) - endTimeMs(b);
              if (t !== 0) return t;
            }
            return aKey - bKey;
          }
          return aKey - bKey;
        });

        tbody.innerHTML = "";
        let cumPeople = 0;
        const isMobile = window.matchMedia("(max-width: 560px)").matches;

        for (const g of sorted){
          const nm = (g.name || "").trim();
          if (q && !nm.toLowerCase().includes(q)) continue;

          cumPeople += Number(g.partySize || 0);

          const exts = Array.isArray(g.extends) ? g.extends : [];
          const c30 = exts.filter((e) => Number(e.min) === 30).length;
          const c60 = exts.filter((e) => Number(e.min) === 60).length;
          const c90 = exts.filter((e) => Number(e.min) === 90).length;
          const extMin = totalExtMin(g);
          const extText = `30:${c30} 60:${c60} 90:${c90} ï½œ åˆè¨ˆ${extMin}åˆ†`;

          const statusClass = g.checkOutAt ? "row-done" : "row-stay";
          const tr = document.createElement("tr");
          tr.className = statusClass + (isMobile ? " mrow" : "");

          if (isMobile){
            tr.innerHTML = `
              <td class="m-lbl m-no-lbl">No</td><td class="m-val m-no-val">${Number(g.ticketNo) || ""}</td>
              <td class="m-lbl m-cum-lbl">ç´¯è¨ˆ</td><td class="m-val m-cum-val">${cumPeople}</td>
              <td class="m-lbl m-seat-lbl">äººæ•°</td><td class="m-val m-seat-val">${Number(g.partySize || 0)}å</td>
              <td class="m-lbl m-name-lbl">ãŠåå‰</td><td class="m-val m-name-val">${escapeHtml(nm || "æœªå…¥åŠ›")}</td>
              <td class="m-lbl m-in-lbl">å…¥åº—</td><td class="m-val m-in-val">${toHHMM(new Date(g.checkInAt))}</td>
              <td class="m-lbl m-out-lbl">é€€åº—</td><td class="m-val m-out-val">${g.checkOutAt ? toHHMM(new Date(g.checkOutAt)) : toHHMM(dueAt(g))}</td>
              <td class="m-lbl m-ext-lbl">å»¶é•·</td><td class="m-val m-ext-val">${escapeHtml(extText)}</td>
            `;
          }else{
            const status = g.checkOutAt ? "é€€åº—æ¸ˆ" : "æ»åœ¨ä¸­";
            tr.innerHTML = `
              <td class="td-muted">${Number(g.ticketNo) || ""}</td>
              <td class="td-muted">${cumPeople}</td>
              <td class="td-strong">${escapeHtml(g.checkOutAt ? (g.lastSeatLabel || g.primarySeat || g.seatId || "") : (g.primarySeat || g.seatId || ""))}</td>
              <td class="td-strong">${escapeHtml(guestTypeLabel(g))}</td>
              <td class="td-wrap">
                ${escapeHtml(nm || "æœªå…¥åŠ›")}
                ${g.note ? `<div class="td-muted">ğŸ“ ${escapeHtml(g.note)}</div>` : ""}
              </td>
              <td>${Number(g.partySize || 0)}</td>
              <td>${toHHMM(new Date(g.checkInAt))}</td>
              <td>${g.checkOutAt ? toHHMM(new Date(g.checkOutAt)) : toHHMM(dueAt(g))}</td>
              <td class="td-wrap">${escapeHtml(extText)}</td>
              <td class="${g.checkOutAt ? "td-muted" : "td-strong"}">${status}</td>
            `;
          }
          tbody.appendChild(tr);
        }
      };

      const formatBizDateJP = (bizStr) => {
        const [y, m, d] = bizStr.split("-").map(Number);
        const dt = new Date(y, m - 1, d);
        const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][dt.getDay()];
        return `${y}å¹´${m}æœˆ${d}æ—¥(${w})`;
      };

      const renderStatus = () => {
        const staying = groups.filter((g) => !g.checkOutAt);
        const stayingGroups = staying.length;
        const stayingPeople = staying.reduce((a, g) => a + Number(g.partySize || 0), 0);
        const totalGroups = groups.length;
        const totalPeople = groups.reduce((a, g) => a + Number(g.partySize || 0), 0);

        headerStatus.innerHTML = `
          <div class="hs-date">${formatBizDateJP(currentBizDate)}</div>
          <div class="hs-stats">
            æ»åœ¨ä¸­ <b>${stayingGroups}</b>çµ„<b>${stayingPeople}</b>å
            <span class="hs-sep">ï¼</span>
            ç´¯è¨ˆ <b>${totalGroups}</b>çµ„<b>${totalPeople}</b>å
          </div>
        `;
      };

      const renderAll = () => { renderSeats(); renderTable(); renderStatus(); };

      async function setBizDate(newDateStr){
        currentBizDate = newDateStr;
        datePicker.value = currentBizDate;

        const data = await loadDay(currentBizDate);
        groups = (data || []).map(normalizeGroup);
        renderAll();
      }

      btnToday.addEventListener("click", () => setBizDate(businessDateFor(new Date())));
      btnPrev.addEventListener("click",  () => setBizDate(addDaysToBizDate(currentBizDate, -1)));
      btnNext.addEventListener("click",  () => setBizDate(addDaysToBizDate(currentBizDate, +1)));
      datePicker.addEventListener("change", () => { if (datePicker.value) setBizDate(datePicker.value); });

      btnSortEnd.addEventListener("click", () => {
        sortByEnd = !sortByEnd;
        btnSortEnd.textContent = sortByEnd ? "å…¥åº—é †ã«æˆ»ã™" : "çµ‚äº†æ™‚é–“é †";
        renderTable();
      });
      search.addEventListener("input", renderTable);

      async function boot(){
        // ?bizDate=YYYY-MM-DD æŒ‡å®šãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
        const url = new URL(location.href);
        const qBiz = url.searchParams.get("bizDate");
        const startBiz = qBiz && /^\d{4}-\d{2}-\d{2}$/.test(qBiz) ? qBiz : businessDateFor(new Date());

        datePicker.value = startBiz;
        await setBizDate(startBiz);

        // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆé–²è¦§å°‚ç”¨å‘ã‘ï¼‰
        setInterval(async () => {
          const data = await loadDay(currentBizDate);
          groups = (data || []).map(normalizeGroup);
          renderAll();
        }, 30 * 1000);
      }

      boot();
    })();
  </script>
</body>
</html>