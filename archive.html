<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ—ãƒ©ãƒãƒŠ æ¥åº—ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</title>

  <!-- å…±é€šCSSï¼ˆå“ç®¡ç†ãƒ„ãƒ¼ãƒ«å´ã¨åŒã˜ã‚„ã¤ï¼‰ -->
  <link rel="stylesheet" href="assets/style.css">

  <style>
/* =========================================================
   PLATINA ARCHIVE (PC ONLY / Single Source of Truth)
   - Mobileå°‚ç”¨CSSã¯å®Œå…¨æ’¤å»ƒï¼ˆåŒã˜è¦‹ãŸç›®ã§ç¸®ã‚€ã ã‘ï¼‰
   - Fix:
     1) å—ä»˜è¡¨ã®ç¸ï¼’é‡ã‚’æ ¹çµ¶ï¼ˆç´«æ ãªã©ã‚’æ¶ˆã™ï¼‰
     2) åŒºåˆ†åˆ—ã‚’å°‘ã—åºƒã’ã‚‹
   ========================================================= */

/* ===== tokens ===== */
:root{
  --arch-line:  var(--accent-12);
  --arch-frame: var(--accent-55);
  --arch-frameW: 2px;

  --pagePadX: 25px;

  --sumHi: rgba(255,255,255,.92);
  --sumLo: rgba(68,50,140,.12);

  /* table frame (single) */
  --tblFrame: rgba(255,95,174,.45);     /* å¤–æ ãƒ”ãƒ³ã‚¯ */
  --tblLine:  rgba(255,95,174,.20);     /* ä»•åˆ‡ã‚Šè–„ãƒ”ãƒ³ã‚¯ */
  --tblLine2: rgba(107,86,255,.00);     /* â˜…ç´«ã¯ä½¿ã‚ãªã„ï¼ˆ0ã§æ®ºã™ï¼‰ */
}

/* ===== app width ===== */
body.archive .app{
  max-width:1150px;
  margin: 0 auto;
}

/* =========================================================
   Header
   ========================================================= */
body.archive header.arch-header{
  margin-top: 10px;
  padding-left:  var(--pagePadX);
  padding-right: var(--pagePadX);

  border-radius: var(--r2);
  border: var(--arch-frameW) solid var(--arch-frame);
  background: linear-gradient(180deg, #ffffff, #f1ecff);
  box-shadow: var(--shadow), var(--bevel-out);
}

body.archive header.arch-header .topbar{
  display:flex;
  align-items:center;
  width:100%;
  gap:12px;
  flex-wrap:nowrap;
}

/* â˜…ãƒ˜ãƒƒãƒ€ãƒ¼æœˆã‚¿ã‚¤ãƒˆãƒ« å·¦å¯„ã› */
body.archive .arch-left{
  flex:1 1 auto;
  min-width: 180px;
  text-align:left;
}
body.archive .arch-month{
  font-size: 22px;
  font-weight: 1000;
  letter-spacing: .02em;
  color: var(--ink);
  line-height: 1.1;
  white-space: nowrap;
}

body.archive .arch-controls{
  margin-left:auto;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:8px;
  flex-wrap:nowrap;
}

/* fieldï¼ˆãƒ”ãƒ«ï¼‰ */
body.archive header.arch-header .field{
  height: 36px;
  padding: 0 12px;
  border-radius: 999px;

  border: 2px solid var(--accent-35);
  background: linear-gradient(180deg, #ffffff, #eaf7ff);
  box-shadow: var(--bevel-out);

  display:flex;
  align-items:center;
  gap:8px;
  min-width: 0;
}
body.archive header.arch-header .field .ico{
  line-height: 1;
  opacity: .9;
  user-select:none;
}
body.archive header.arch-header .field input{
  border: 0;
  outline: 0;
  background: transparent;
  height: 100%;
  font-weight: 1000;
  color: var(--ink);
  font-size: 13px;
  min-width: 140px;
}

/* btn */
body.archive .btn{
  appearance:none;
  border:2px solid var(--accent-55);
  border-radius:999px;
  padding:8px 12px;
  font-weight:1000;
  font-size:13px;
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
  background: linear-gradient(180deg, #ffffff, #f3ecff);
  color:var(--ink);
  box-shadow: var(--bevel-out);
}
body.archive .btn:active{ transform: translateY(1px); box-shadow: var(--bevel-in); }

body.archive header.arch-header .btn.ghost{
  border-color: rgba(84,215,255,.55);
  background: linear-gradient(180deg, #ffffff, #eaf7ff);
}
body.archive header.arch-header .btn.primary{
  border-color: rgba(255,95,174,.65);
  background: linear-gradient(180deg, #fff, #ffe1f1);
  color:#3b1740;
}

/* ===== Rainbow button (for New Tracker link) ===== */
body.archive .btn.rainbowBtn{
  border: 2px solid transparent;
  background:
    /* inner fill */
    linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.74)) padding-box,
    /* rainbow frame */
    linear-gradient(90deg,
      #ff8ec8, #7fe4ff, #ffe07a
    ) border-box;

  color: rgba(26,16,32,.92);
  text-shadow: 0 1px 0 rgba(255,255,255,.85);

  box-shadow:
    var(--bevel-out),
    0 10px 18px rgba(68,50,140,.10);
}

/* æŠ¼ã—ãŸæ™‚ */
body.archive .btn.rainbowBtn:active{
  transform: translateY(1px);
  box-shadow: var(--bevel-in);
}

/* ãƒ›ãƒãƒ¼ã§å°‘ã—ã‚­ãƒ©ã£ã¨ */
@media (hover:hover){
  body.archive .btn.rainbowBtn:hover{
    filter: saturate(1.15) contrast(1.03);
  }
}


/* =========================================================
   Panel
   ========================================================= */
body.archive .panel{
  margin-top:12px;
  border-radius: var(--r2);
  border: 2px solid var(--accent-55);
  background: linear-gradient(180deg, #ffffff, #f7f2ff);
  box-shadow: var(--shadow), var(--bevel-out);
  overflow:hidden;
}

body.archive .panelHead{
  padding:14px;
  border-bottom: 1px solid var(--arch-line);
  background:
    linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.78)),
    radial-gradient(900px 260px at 0% 0%, rgba(255,95,174,.12), transparent 60%),
    radial-gradient(900px 260px at 100% 0%, rgba(84,215,255,.12), transparent 60%);
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-start;
}

body.archive .metaRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

body.archive .pill{
  border:2px solid var(--accent-18);
  background: linear-gradient(180deg, #ffffff, #faf7ff);
  box-shadow: var(--bevel-out);
  color: rgba(20,12,40,.92);
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: 12px;
  white-space:nowrap;
}

/* æœˆãƒãƒ¼ */
body.archive .monthBar{
  padding:10px 12px 12px;
  border-bottom: 1px solid var(--arch-line);
  background: rgba(255,255,255,.78);

  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
body.archive .monthBar .left{ color:var(--muted); font-size:12px; font-weight:1000; }
body.archive .monthBar .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

body.archive #btnCollapseAll,
body.archive #btnExpandWithData{
  border-color: rgba(84,215,255,.55);
  background: linear-gradient(180deg, #ffffff, #eaf7ff);
}
body.archive #btnBuildMonthStats{
  border-color: rgba(255,95,174,.65);
  background: linear-gradient(180deg, #ffffff, #ffe1f1);
  color:#3b1740;
}

body.archive .dayList{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* =========================================================
   Day
   ========================================================= */
body.archive details.day{
  --dayFrame: rgba(107,86,255,.35);
  --dayBarDeep: rgba(166,155,255,.68);
  --dayInk: var(--ink);

  --sumGrad: var(--seatbarC);
  --sumLine: rgba(120,110,255,.26);

  --dayCardFrame: rgba(120,110,255,.35);

  border: 0;
  background: transparent;
  box-shadow: none;
  overflow: visible;
}

body.archive details.day[data-kind="open"]{
  --dayFrame: rgba(255,95,174,.55);
  --dayBarDeep: rgba(255,95,174,.95);
  --sumGrad: linear-gradient(180deg, rgba(255,174,214,.98), rgba(255,126,188,.93));
  --sumLine: rgba(255,95,174,.45);
  --dayCardFrame: rgba(255,95,174,.55);
}
body.archive details.day[data-kind="noguest"]{
  --dayFrame: rgba(84,215,255,.60);
  --dayBarDeep: rgba(84,215,255,.95);
  --sumGrad: linear-gradient(180deg, rgba(191,239,255,.98), rgba(140,224,255,.93));
  --sumLine: rgba(84,215,255,.45);
  --dayCardFrame: rgba(84,215,255,.55);
}
body.archive details.day[data-kind="closed"]{
  --dayFrame: rgba(107,86,255,.55);
  --dayBarDeep: rgba(107,86,255,.86);
  --sumGrad: linear-gradient(180deg, rgba(224,219,255,.98), rgba(178,168,255,.93));
  --sumLine: rgba(107,86,255,.45);
  --dayCardFrame: rgba(107,86,255,.55);
}

/* Summaryï¼ˆå¸¯ï¼‰ */
body.archive details.day > summary{
  cursor:pointer;
  list-style:none;

  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;

  position: relative;
  margin: 0;
  padding:12px 12px 12px 26px;
  border-radius: 18px;

  background: var(--sumGrad);
  border: 2px solid color-mix(in srgb, var(--sumLine) 70%, rgba(255,255,255,0));
  border-bottom-color: var(--sumLine);

  box-shadow:
    inset 0 3px 0 var(--sumHi),
    inset 3px 0 0 rgba(255,255,255,.70),
    inset 0 -3px 0 var(--sumLo),
    inset -3px 0 0 rgba(68,50,140,.10),
    0 10px 18px rgba(68,50,140,.10);
}
body.archive summary::-webkit-details-marker{ display:none; }

body.archive details.day > summary::before{
  content:"";
  position:absolute;
  left:12px;
  top:10px;
  bottom:10px;
  width:8px;
  border-radius:999px;
  background: var(--dayBarDeep);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.50),
    inset 0 -1px 0 rgba(68,50,140,.12);
}

body.archive details.day[open] > summary{
  filter: saturate(1.02);
  box-shadow:
    inset 0 3px 0 var(--sumHi),
    inset 3px 0 0 rgba(255,255,255,.70),
    inset 0 -3px 0 var(--sumLo),
    inset -3px 0 0 rgba(68,50,140,.10),
    0 14px 22px rgba(68,50,140,.14);
  z-index: 2;
}

/* Summary inner */
body.archive .dayLeft{
  display:flex;
  gap:12px;
  align-items:center;
  min-width:0;
  font-weight:1000;
  color: var(--dayInk);
}
body.archive .dayNum{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:14px;

  border:2px solid rgba(0,0,0,.04);
  background: linear-gradient(180deg, #ffffff, #faf7ff);
  box-shadow: var(--bevel-out);
  white-space:nowrap;
}
body.archive .dayNum .d{ font-size:20px; font-weight:1000; line-height:1; }
body.archive .dayNum .w{
  font-size:12px;
  font-weight:1000;
  line-height:1;
  padding:3px 8px;
  border-radius:999px;
  background: var(--accent-10);
  color: rgba(42,33,80,.78);
}

body.archive .dayText{ min-width:0; flex: 1 1 auto; }

/* â˜…PCã¯çµ±è¨ˆãƒ”ãƒ«ã¯æ¨ªä¸€åˆ—ï¼ˆæŠ˜ã‚Šè¿”ã—ç¦æ­¢ï¼‰ */
body.archive .barStatsPills{
  display:flex;
  flex-direction: row;
  flex-wrap: nowrap;
  align-items:center;
  gap: 8px;
  min-width: 0;
}
body.archive .barStatsPills .pill{
  display:inline-flex;
  flex: 0 0 auto;
  align-items:center;
  justify-content:center;
  padding: 6px 10px;
  font-size: 12px;
  line-height: 1.1;
  white-space: nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Right side */
body.archive .dayRight{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}
body.archive details.day .dayAct{
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;

  border: 2px solid var(--dayFrame);
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
  box-shadow: var(--bevel-out), 0 10px 18px rgba(68,50,140,.10);
  font-weight:1000;
  font-size:12px;
  white-space:nowrap;
}

/* â˜…ãƒ¡ãƒ¢ã¯ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚ã‚Š/ãªã—ä¸¡æ–¹ã§çµ±ä¸€ï¼‰ */
body.archive .memoIcon{
  width:34px; height:34px;
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border:2px solid var(--accent-18);
  background: linear-gradient(180deg, #ffffff, #faf7ff);
  box-shadow: var(--bevel-out);
  pointer-events:none;
  user-select:none;
}

/* æ—§ãƒ¡ãƒ¢ãƒ”ãƒ«ã¯æ®ºã™ï¼ˆæ®‹éª¸é˜²æ­¢ï¼‰ */
body.archive .memoPill{ display:none !important; }

/* Open body */
body.archive .dayBody{ padding:12px; border-top: 0; background: transparent; }
body.archive details.day[open] .dayBody{
  position: relative;
  z-index: 1;

  margin: -8px 0 0;
  padding: 16px 12px 12px;

  border: 2px solid var(--dayCardFrame);
  border-top: 0;
  border-radius: 0 0 18px 18px;

  background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.82));
  box-shadow: var(--shadow), var(--bevel-out);
}

/* chips */
body.archive .dayOrder{ display:flex; gap:8px; margin-bottom:10px; }
body.archive .dayOrder .chip{
  cursor:pointer;
  border:2px solid var(--accent-18);
  padding:8px 12px;
  border-radius:999px;
  background: linear-gradient(180deg, #ffffff, #faf7ff);
  box-shadow: var(--bevel-out);
  font-weight:1000;
  font-size:12px;
}
body.archive .dayOrder .chip.on{
  color:#fff;
  border-color: rgba(255,95,174,.35);
  background: linear-gradient(135deg, var(--pink), var(--accent));
  box-shadow: 0 8px 0 rgba(255,95,174,.12);
}

/* =========================================================
   TABLE (single frame / no double border)
   ========================================================= */

/* â˜…å¤–å´ã ã‘ã«æ ã€‚ä¸­ã¯ã€Œç·šã€ã ã‘ã€‚ */
body.archive .tableWrap{
  border: 2px solid var(--tblFrame);
  border-radius: 16px;
  overflow:hidden;
  background: rgba(255,255,255,.92);
  box-shadow: none;

  /* ç´«æ ã‚„ç–‘ä¼¼è¦ç´ ãŒç´›ã‚Œã¦ã¦ã‚‚æ®ºã™ */
  outline: 0 !important;
}
body.archive .tableWrap::before,
body.archive .tableWrap::after{
  content:none !important;
  display:none !important;
}

/* â˜…ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªèº«ã«ã¯æ ã‚’æŒãŸã›ãªã„ï¼ˆ2é‡ã®åŸå› ï¼‰ */
body.archive table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  table-layout: fixed;
  border: 0 !important;
  outline: 0 !important;
  box-shadow: none !important;
}

/* ===== header ===== */
body.archive thead th{
  position:sticky; top:0;
  background: linear-gradient(180deg, #ffe1f1, #ff6fb2);
  color: rgba(42,33,80,.92);
  padding:10px 8px;
  font-size:12px;
  font-weight:1000;
  white-space:nowrap;

  border-bottom:2px solid rgba(255,95,174,.35);
  border-right:1px solid var(--tblLine);
  overflow:hidden;
  text-overflow:ellipsis;
}
body.archive thead th:last-child{ border-right:none; }

/* ===== body ===== */
body.archive tbody td{
  padding:10px 8px;
  font-size:13px;
  font-weight:800;
  color: rgba(42,33,80,.92);

  border-bottom:1px solid var(--arch-line);
  border-right:1px solid rgba(255,95,174,.14);

  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  vertical-align: middle;
}
body.archive tbody td:last-child{ border-right:none; }
body.archive tbody tr:last-child td{ border-bottom:0; }
body.archive tbody tr:hover td{ background:#fff3d1; }

/* ===== åŒºåˆ†ãƒãƒƒã‚¸ï¼ˆtableç”¨ï¼‰ ===== */
body.archive .kbn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding: 2px 8px;
  border-radius:999px;
  font-weight:1000;
  font-size: 12px;
  border:2px solid rgba(0,0,0,.08);
  background: linear-gradient(180deg, #fff, #faf7ff);
  color: rgba(42,33,80,.90);
}
body.archive .kbn.new{
  border-color: rgba(255,95,174,.55);
  background: linear-gradient(180deg, #fff, #ffe1f1);
  color: #5a1a4a;
}
body.archive .kbn.repeat{
  border-color: rgba(84,215,255,.55);
  background: linear-gradient(180deg, #fff, #eaf7ff);
  color: #1b3f57;
}

/* =========================================================
   FIX 1: åŒºåˆ†åˆ—ã‚’å°‘ã—åºƒã’ã‚‹
   - colgroupãŒã‚ã‚‹ãªã‚‰ãã‚Œã‚’æœ€å„ªå…ˆ
   - ç„¡ã„å ´åˆã§ã‚‚ nth-child(4) ã‚’åºƒã’ã‚‹
   ========================================================= */

/* colgroupï¼ˆHTMLå´ã« <col class="col-kbn"> ãŒã‚ã‚‹ãªã‚‰åŠ¹ãï¼‰ */
body.archive table col.col-kbn{ width: 112px; } /* â˜…92â†’112ã«æ‹¡å¤§ */

/* colgroupãŒç„¡ã„/åŠ¹ã‹ãªã„å ´åˆã®ä¿é™º */
body.archive thead th:nth-child(4),
body.archive tbody td:nth-child(4){
  width: 112px;
}

/* ã¤ã„ã§ã« No/ç´¯è¨ˆ/å“ç•ªã¯å°‘ã—è©°ã‚ãŸã„æ™‚ã®ä¿é™ºï¼ˆå¿…è¦ãªã‚‰ONï¼‰
body.archive thead th:nth-child(1),
body.archive tbody td:nth-child(1){ width: 44px; }
body.archive thead th:nth-child(2),
body.archive tbody td:nth-child(2){ width: 60px; }
body.archive thead th:nth-child(3),
body.archive tbody td:nth-child(3){ width: 64px; }
*/

/* memo full */
body.archive .memoFull{
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;

  border: 2px solid rgba(255,95,174,.45);
  background: rgba(255,255,255,.92);
  box-shadow: none;

  font-weight:900;
  color: rgba(26,16,32,.82);
  white-space: pre-wrap;
}

body.archive .empty{
  padding:14px;
  color: var(--muted);
  text-align:center;
  font-weight:1000;
  white-space:pre-wrap;
}
body.archive .sr-only{
  position:absolute;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

/* åœŸæ—¥ */
body.archive details.day[data-dow="åœŸ"] .dayNum .w{
  background: rgba(84,215,255,.50);
  color: rgba(20,40,80,.88);
}
body.archive details.day[data-dow="æ—¥"] .dayNum .w{
  background: rgba(255,95,174,.50);
  color: rgba(70,18,45,.88);
}

  </style>
</head>

<body class="archive">
  <div class="app">

    <!-- JSãŒå‚ç…§ã—ã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ç½®ã„ã¦ãŠãï¼ˆè¦‹ã›ãªã„ï¼‰ -->
    <div id="status" class="sr-only">OK</div>

    <!-- ========== HEADER ========== -->
    <header class="arch-header">
      <div class="topbar">
        <div class="arch-left">
          <div class="arch-month" id="hdrMonth">----</div>
        </div>

		<a class="btn rainbowBtn"
   href="https://platinatimemanager.pages.dev/"
   target="_blank" rel="noopener">
  ğŸ’—
</a>

		<a class="btn rainbowBtn"
   href="https://platinatimemanager.pages.dev/newtracker"
   target="_blank" rel="noopener">
  ğŸ†•
</a>


        <div class="arch-controls">
          <div class="field" title="æœˆ">
            <input type="month" id="monthPicker" />
          </div>

          <div class="field" title="æ¤œç´¢ï¼ˆå¸­/åå‰/ãƒ¡ãƒ¢ãªã©ï¼‰">
            <span class="ico">ğŸ”</span>
            <input type="text" id="q" placeholder="ä¾‹:BOX2 / ã•ã•ã / å»¶é•·" />
          </div>

		   

          <button class="btn ghost" id="btnJumpLatest" type="button">æœ€æ–°æ—¥ã«é£›ã¶</button>
          <button class="btn primary" id="btnReload" type="button">å†èª­ã¿</button>
        </div>
      </div>
    </header>

    <!-- ========== PANELï¼ˆæœˆå…¨ä½“ï¼‰ ========== -->
    <section class="panel" id="panel">
      <div class="panelHead">
        <div>
          <div class="pill" id="monthBadge">--</div>
        </div>

        <div class="metaRow">
          <div class="pill" id="monthStatPill">æœˆçµ±è¨ˆ:æœªè¨ˆç®—</div>
          <div class="pill" id="monthSearchPill">æ¤œç´¢:ãªã—</div>
        </div>
      </div>

      <div class="monthBar">
        <div class="left" id="monthBarLeft">æœˆçµ±è¨ˆã¯ã€Œæœˆçµ±è¨ˆã‚’ä½œã‚‹ã€ã§è¨ˆç®—ã§ãã¾ã™ã€‚</div>
        <div class="right">
          <button class="btn ghost" id="btnCollapseAll" type="button">å…¨éƒ¨ãŸãŸã‚€</button>
          <button class="btn ghost" id="btnExpandWithData" type="button">ãƒ‡ãƒ¼ã‚¿æ—¥ã ã‘é–‹ã</button>
          <button class="btn primary" id="btnBuildMonthStats" type="button">æœˆçµ±è¨ˆã‚’ä½œã‚‹</button>
        </div>
      </div>

      <div class="dayList" id="dayList"></div>
    </section>

    <div class="empty" style="margin-top:12px;">
      â€» æ—¥åˆ¥çµ±è¨ˆï¼ˆå»¶é•·ç‡/å¹³å‡æ»åœ¨ãªã©ï¼‰ã¯ã€ãã®æ—¥ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
    </div>

  </div><!-- /.app -->

<script>
"use strict";

/* ========= crash reporterï¼ˆç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ï¼‰ ========= */
(function attachCrashReporter(){
  const show = (title, err) => {
    console.error(title, err);
    const box = document.getElementById("fatalBox") || (() => {
      const d = document.createElement("div");
      d.id = "fatalBox";
      d.style.cssText = `
        position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 99999;
        padding: 12px 14px; border-radius: 14px;
        border: 2px solid rgba(255,95,182,.55);
        background: #fff; color: #2a2150;
        box-shadow: 0 10px 24px rgba(0,0,0,.18);
        font: 12px/1.45 Meiryo, system-ui, sans-serif;
        white-space: pre-wrap;
      `;
      document.body.appendChild(d);
      return d;
    })();
    const msg = err?.stack || err?.message || String(err);
    box.textContent = `ğŸš¨ ${title}\n\n${msg}`;
  };

  window.addEventListener("error", (e) => show("JS Error", e.error || e.message));
  window.addEventListener("unhandledrejection", (e) => show("Promise Rejection", e.reason));
})();

/* ========= è¨­å®š ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbzEmg4re7mtYNcktLIk2hodRzuREBJsZHyHG3Nh_fep-FhGjm7TNcYCqRRaQAjRWKrghA/exec";
const ENDPOINTS = {
  month: (ym) => `${API_URL}?action=month&ym=${encodeURIComponent(ym)}`,
  day:   (d)  => `${API_URL}?action=day&bizDate=${encodeURIComponent(d)}`,
  setDay:  (d, status, note) => `${API_URL}?action=setday&bizDate=${encodeURIComponent(d)}&status=${encodeURIComponent(status)}&note=${encodeURIComponent(note||"")}`,
  clearDay:(d) => `${API_URL}?action=clearday&bizDate=${encodeURIComponent(d)}`
};

const CACHE_PREFIX = "platinataku_archive_day_table_";
const CACHE_TTL_MS = 1000 * 60 * 10;

/* ========= util ========= */
const $ = (s)=>document.querySelector(s);
const pad2=(n)=>String(n).padStart(2,"0");

const el = (tag, attrs={}, children=[])=>{
  const n=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==="class") n.className=v;
    else if(k==="text") n.textContent=v;
    else if(k==="html") n.innerHTML=v;
    else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k,v);
  }
  for(const c of children) n.appendChild(c);
  return n;
};

function toYM(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function ymLabel(ym){ const [y,m]=ym.split("-"); return `${y}å¹´${Number(m)}æœˆ`; }
function daysInMonth(ym){ const [y,m]=ym.split("-").map(Number); return new Date(y,m,0).getDate(); }
function dateStr(ym, day){ return `${ym}-${pad2(day)}`; }
function fmtBizDateSlash(ds){
  const [y,m,d] = String(ds).split("-");
  return `${Number(y)}/${Number(m)}/${Number(d)}`;
}
function dayNumber(ds){ return Number(String(ds).split("-")[2] || 0); }

function dowLabel(ds){
  const d=new Date(ds+"T00:00:00");
  return ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()];
}
function safeDow(iso){
  try{ return dowLabel(iso) || ""; }
  catch(e){ console.warn("dowLabel failed:", iso, e); return ""; }
}
function clipText(s, n){
  s = String(s || "").trim();
  if(!s) return "";
  return (s.length > n) ? (s.slice(0, n) + "â€¦") : s;
}

/* â˜…statusãŒæ¶ˆãˆã¦ã‚‚è½ã¡ãªã„ */
function setStatus(t){
  const s = document.getElementById("status");
  if(s) s.textContent = String(t ?? "");
}

/* ===== JSONå–å¾— ===== */
async function fetchJSON(url){
  const res = await fetch(url, { method:"GET", cache:"no-store" });
  const text = await res.text();

  try { return JSON.parse(text); } catch {}

  // JSONPä¿é™º
  const m = text.match(/^[\s\w$.]+\(\s*([\s\S]*)\s*\)\s*;?\s*$/);
  if(m){
    try { return JSON.parse(m[1]); } catch {}
  }
  throw new Error("Non-JSON response: " + text.slice(0, 160));
}

/* ===== cache ===== */
function cacheGet(key){
  try{
    const v=localStorage.getItem(key);
    if(!v) return null;
    const o=JSON.parse(v);
    if(Date.now()-o.t > CACHE_TTL_MS) return null;
    return o.data;
  }catch{ return null; }
}
function cacheSet(key,data){
  try{ localStorage.setItem(key, JSON.stringify({t:Date.now(), data})); }catch{}
}

/* ========= å“ç®¡ç†ãƒ„ãƒ¼ãƒ«æ–¹å¼ï¼šISOã¯ Date å¾©å…ƒã—ã¦JSTè¡¨ç¤º ========= */
const toHHMM = (d)=> `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

function fmtTime(v){
  if(v == null) return "-";
  if(v instanceof Date && !isNaN(v)) return toHHMM(v);

  const s = String(v).trim();
  if(!s) return "-";

  const m = s.match(/^(\d{1,2}):(\d{2})$/);
  if(m) return `${pad2(Number(m[1]))}:${m[2]}`;

  const dt = new Date(s);
  if(!isNaN(dt)) return toHHMM(dt);

  const m2 = s.match(/\b(\d{1,2}):(\d{2})\b/);
  if(m2) return `${pad2(Number(m2[1]))}:${m2[2]}`;

  return "-";
}
function diffMinutesByISO(inAt, outAt){
  const a = new Date(inAt);
  const b = new Date(outAt);
  if(isNaN(a) || isNaN(b)) return null;
  return Math.max(0, Math.floor((b - a) / 60000));
}

/* ========= å»¶é•·é›†è¨ˆ ========= */
function sumExtendMinutes(g){
  const ex = Array.isArray(g.extends) ? g.extends : [];
  let total = 0;
  for(const it of ex){
    if(typeof it === "number") total += it;
    else if(typeof it === "string" && /^\d+$/.test(it)) total += Number(it);
    else if(it && typeof it === "object"){
      if(typeof it.min === "number") total += it.min;
      else if(typeof it.minutes === "number") total += it.minutes;
      else if(typeof it.m === "number") total += it.m;
    }
  }
  return total;
}
function extendBreakdown(g){
  const ex = Array.isArray(g.extends) ? g.extends : [];
  const map = {};
  for(const it of ex){
    let m = null;
    if(typeof it === "number") m = it;
    else if(it && typeof it === "object"){
      if(typeof it.min === "number") m = it.min;
      else if(typeof it.minutes === "number") m = it.minutes;
    }
    if(m != null) map[m] = (map[m]||0)+1;
  }
  const keys = Object.keys(map).map(Number).sort((a,b)=>a-b);
  const parts = keys.map(k=>`${k}:${map[k]}`);
  const total = keys.reduce((acc,k)=>acc + k*map[k], 0);
  return { parts, total };
}

/* ========= æ–°è¦/ãƒªãƒ”åˆ¤å®š ========= */
function guestTypeLabel(gt){
  const s = String(gt||"").trim().toLowerCase();
  if(["new","æ–°è¦","shinki","first","åˆå›","0"].includes(s)) return "æ–°è¦";
  if(["repeat","repeater","ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼","ãƒªãƒ”","1"].includes(s)) return "ãƒªãƒ”";
  if(!s) return "ä¸æ˜";
  if(s.includes("new") || s.includes("æ–°è¦") || s.includes("åˆ")) return "æ–°è¦";
  if(s.includes("repeat") || s.includes("ãƒªãƒ”") || s.includes("å¸¸é€£") || s.includes("å†æ¥")) return "ãƒªãƒ”";
  return "ä¸æ˜";
}
function guestTypeClass(gt){
  const lbl = guestTypeLabel(gt);
  if(lbl==="æ–°è¦") return "new";
  if(lbl==="ãƒªãƒ”") return "repeat";
  return "other";
}

/* ========= stats ========= */
function emptyStats(){
  return {
    groupsTotal:0, peopleTotal:0,
    groupsNew:0, peopleNew:0,
    groupsRepeat:0, peopleRepeat:0,
    groupsOther:0, peopleOther:0,
    extendedGroups:0, extendMinutesTotal:0,
    staySamples:0, stayMinutesTotal:0
  };
}
function calcStats(groups){
  const st=emptyStats();
  for(const g of (groups||[])){
    const p=Number(g.partySize||1);
    const lbl = guestTypeLabel(g.guestType);

    st.groupsTotal += 1;
    st.peopleTotal += p;

    if(lbl==="æ–°è¦"){ st.groupsNew++; st.peopleNew += p; }
    else if(lbl==="ãƒªãƒ”"){ st.groupsRepeat++; st.peopleRepeat += p; }
    else { st.groupsOther++; st.peopleOther += p; }

    const exMin = sumExtendMinutes(g);
    if(exMin>0){ st.extendedGroups++; st.extendMinutesTotal += exMin; }

    if(g.checkInAt && g.checkOutAt){
      const stay = diffMinutesByISO(g.checkInAt, g.checkOutAt);
      if(stay != null){
        st.staySamples++;
        st.stayMinutesTotal += stay;
      }
    }
  }
  return st;
}
function statPills(st){
  const extRate = st.groupsTotal ? Math.round(st.extendedGroups / st.groupsTotal * 100) : 0;
  const avgStay = st.staySamples ? Math.round(st.stayMinutesTotal / st.staySamples) : 0;
  const avgExt  = st.groupsTotal ? Math.round(st.extendMinutesTotal / st.groupsTotal) : 0;

  return [
    `åˆè¨ˆ${st.groupsTotal}çµ„${st.peopleTotal}å`,
    `æ–°è¦${st.groupsNew}çµ„${st.peopleNew}å`,
    `ãƒªãƒ”${st.groupsRepeat}çµ„${st.peopleRepeat}å`,
    `å»¶é•·ç‡${extRate}%`,
    `å¹³å‡æ»åœ¨${avgStay}åˆ†`,
    `å¹³å‡å»¶é•·${avgExt}åˆ†`
  ];
}

/* ========= state ========= */
const state = {
  ym: toYM(new Date()),
  q: "",
  days: [],
  latestWithData: null,
  monthStats: emptyStats(),
  dayCache: {},
  dayOrder: {}
};

/* ========= fatal ========= */
function showFatal(e){
  console.error(e);
  setStatus("å¤±æ•—");
  const list = $("#dayList");
  if(list){
    list.innerHTML = "";
    list.appendChild(el("div",{class:"empty", text:`æœˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ğŸ¥²ï¼ˆ${e.message}ï¼‰`}));
  }
}

/* ========= meta editorï¼ˆå–¶æ¥­æ—¥ï¼ãƒ¡ãƒ¢ã®ã¿ï¼‰ ========= */
function openDayMetaEditor(dayObj, opts={}){
  const memoOnly = !!opts.memoOnly;

  const existed = document.getElementById("dayMetaModal");
  if(existed) existed.remove();

  const back = el("div", {
    id:"dayMetaModal",
    style: `
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    `
  });

  const card = el("div", {
    style: `
      width:min(520px, 96vw);
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      box-shadow:var(--shadow);
      padding:14px;
    `
  });

  const title = el("div",{style:"font-weight:1000; font-size:16px; margin-bottom:10px;"},
    [document.createTextNode(`ğŸ—“ï¸ ${fmtBizDateSlash(dayObj.date)}ï¼ˆ${safeDow(dayObj.date)}ï¼‰ã®è¨­å®š`)]
  );

  const noteIn = el("input", {
    value: dayObj.note || "",
    placeholder: memoOnly ? "ãƒ¡ãƒ¢ï¼ˆå–¶æ¥­æ—¥:ãƒ¡ãƒ¢ã®ã¿ç·¨é›†ã§ãã¾ã™ï¼‰" : "ãƒ¡ãƒ¢ï¼ˆä¾‹:æˆäººã®æ—¥å–¶æ¥­ã€é›ªã§è‡¨ä¼‘â€¦ï¼‰",
    style: `
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900;
      margin:6px 0 12px;
    `
  });

  let statusSel = null;
  let fixedStatus = "unset";

  if(!memoOnly){
    statusSel = el("select", {
      style: `
        width:100%;
        padding:10px 12px;
        border-radius:999px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.86);
        font-weight:900;
        margin:6px 0 10px;
      `
    }, [
      el("option",{value:"unset",  text:"ãƒ¼ï¼ˆæœªè¨­å®šï¼‰ã«ã™ã‚‹"}),
      el("option",{value:"closed", text:"åº—ä¼‘ã«ã™ã‚‹"}),
      el("option",{value:"noguest",text:"ãƒãƒ¼ã‚²ã‚¹ã«ã™ã‚‹"}),
    ]);
    const cur = String(dayObj.status || "unset").toLowerCase();
    statusSel.value = (cur==="closed"||cur==="noguest") ? cur : "unset";
  }else{
    fixedStatus = "unset";
  }

  const row = el("div",{style:"display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;"});
  const btnClose = el("button",{class:"btn ghost", type:"button", text:"é–‰ã˜ã‚‹", onclick:()=>back.remove()});

  const btnSave = el("button",{class:"btn primary", type:"button", text:"ä¿å­˜", onclick: async ()=>{
    try{
      const st = memoOnly ? fixedStatus : statusSel.value;
      const note = noteIn.value || "";

      if(st==="unset" && !note.trim()){
        await fetchJSON(ENDPOINTS.clearDay(dayObj.date));
      }else{
        await fetchJSON(ENDPOINTS.setDay(dayObj.date, st, note));
      }

      back.remove();
      await loadMonth();
      refreshOpenDays();
    }catch(e){
      alert("å¤±æ•—: " + e.message);
    }
  }});

  row.append(btnClose, btnSave);

  card.append(title);
  if(!memoOnly){
    card.append(el("div",{class:"pill", text:"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„æ—¥ã ã‘ï¼‰"}));
    card.append(statusSel);
  }else{
    card.append(el("div",{class:"pill", text:"å–¶æ¥­æ—¥:ãƒ¡ãƒ¢ã®ã¿ç·¨é›†ã§ãã¾ã™"}));
  }
  card.append(el("div",{class:"pill", text:"ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"}));
  card.append(noteIn);
  card.append(row);

  back.appendChild(card);
  back.addEventListener("click",(ev)=>{ if(ev.target===back) back.remove(); });
  document.body.appendChild(back);
}

/* ========= render month ========= */
function renderMonth(){
  const label = ymLabel(state.ym);
  $("#hdrMonth").textContent = label;

  state.days.sort((a,b)=> String(a.date).localeCompare(String(b.date)));

  // æ—¥æ•°/å–¶æ¥­æ—¥æ•°ï¼ˆãƒ‡ãƒ¼ã‚¿æ—¥ + ãƒãƒ¼ã‚²ã‚¹æ—¥ï¼‰
const totalDays = daysInMonth(state.ym);
const bizDays = state.days.filter(x => {
  const cnt = Number(x.count || 0);
  const st  = String(x.status || "").toLowerCase();
  return (cnt > 0) || (cnt === 0 && st === "noguest"); // ãƒ‡ãƒ¼ã‚¿æ—¥ or ãƒãƒ¼ã‚²ã‚¹æ—¥
}).length;

$("#monthBadge").textContent = `æ—¥æ•°:${totalDays}æ—¥ / å–¶æ¥­æ—¥:${bizDays}æ—¥`;


  $("#monthSearchPill").textContent = state.q ? `æ¤œç´¢:${state.q}` : "æ¤œç´¢:ãªã—";
  $("#dayList").innerHTML = "";

  for(const d of state.days){
    const day = dayNumber(d.date);
    const dow = safeDow(d.date);
    const hasData = Number(d.count||0) > 0;

    const note = (d.note ?? "").toString().trim();
    const hasMemo = !!note;

    const st = String(d.status || "unset").toLowerCase();
    const isClosed  = (!hasData && st === "closed");
    const isNoGuest = (!hasData && st === "noguest");
    const kind = hasData ? "open" : (isClosed ? "closed" : (isNoGuest ? "noguest" : "unset"));

    const det = el("details", { class:"day", "data-date": d.date });
    det.setAttribute("data-kind", kind);
    det.setAttribute("data-dow", dow || "");

    const locked = (!hasData && !hasMemo);
    if(locked){
      det.dataset.locked = "1";
      det.setAttribute("data-locked","1");
    }

    const left = el("div",{class:"dayLeft"},[
      el("div",{class:"dayNum"},[
        el("span",{class:"d", text:String(day)}),
        el("span",{class:"w", text:dow || ""})
      ]),
      el("div",{class:"dayText"},[
        hasData
          ? el("div",{class:"barStatsPills", id:`barstats-${d.date}`},[
              el("div",{class:"pill", text:"çµ±è¨ˆ:æœªè¨ˆç®—"})
            ])
          : el("div",{class:"barStatsPills"})
      ])
    ]);

    const right = el("div",{class:"dayRight"},[]);

    /* â˜…ãƒ¡ãƒ¢ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚ã‚Š/ãªã—ã€ã©ã£ã¡ã‚‚ â€œã‚¢ã‚¤ã‚³ãƒ³ğŸ’­â€ ã«çµ±ä¸€ */
    if(hasMemo){
      right.appendChild(el("span",{ class:"memoIcon", title:"ãƒ¡ãƒ¢ã‚ã‚Šï¼ˆé–‹ãã¨å…¨æ–‡ï¼‰", text:"ğŸ’­" }));
    }

    let labelR = "";
    if(hasData) labelR = `${d.count}ä»¶`;
    else if(isClosed) labelR = "åº—ä¼‘";
    else if(isNoGuest) labelR = "ãƒãƒ¼ã‚²ã‚¹";
    else labelR = "ãƒ¼";

    const btnRight = el("button",{
      type:"button",
      class:"dayAct",
      onclick:(ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        openDayMetaEditor(d, { memoOnly: hasData });
      }
    },[
      el("span",{class:"lab", text: labelR}),
      el("span",{class:"ic",  text:"âœ"})
    ]);

    right.appendChild(btnRight);

    const sum = el("summary",{},[ left, right ]);
    sum.addEventListener("click", (ev)=>{ if(locked) ev.preventDefault(); });

    const bodyKids = [];

    if(!hasData){
      if(hasMemo) bodyKids.push(el("div",{class:"memoFull", text:`ğŸ“ ${note}`}));
    }else{
      if(!state.dayOrder[d.date]) state.dayOrder[d.date] = "in";

      bodyKids.push(
        el("div",{class:"dayCard"},[
          el("div",{class:"dayOrder"},[
            el("button",{
              type:"button",
              class:`chip ${state.dayOrder[d.date]==="in" ? "on" : ""}`,
              id:`ord-in-${d.date}`,
              text:"å…¥åº—é †",
              onclick:(ev)=>{ ev.preventDefault(); ev.stopPropagation(); setDayOrder(d.date, "in"); }
            }),
            el("button",{
              type:"button",
              class:`chip ${state.dayOrder[d.date]==="out" ? "on" : ""}`,
              id:`ord-out-${d.date}`,
              text:"é€€åº—é †",
              onclick:(ev)=>{ ev.preventDefault(); ev.stopPropagation(); setDayOrder(d.date, "out"); }
            })
          ]),

          /* Desktop: table / Mobile: recvList (cards) */
          el("div",{class:"tableWrap"},[
            el("table",{id:`tbl-${d.date}`},[
              el("thead",{},[
                el("tr",{},[
                  el("th",{text:"No"}),
                  el("th",{text:"ç´¯è¨ˆ"}),
                  el("th",{text:"å“ç•ª"}),
                  el("th",{text:"åŒºåˆ†"}),
                  el("th",{text:"ãŠå®¢æ§˜å"}),
                  el("th",{text:"äººæ•°"}),
                  el("th",{text:"å…¥åº—"}),
                  el("th",{text:"é€€åº—"}),
                  el("th",{text:"å»¶é•·"})
                ])
              ]),
              el("tbody",{id:`tb-${d.date}`},[
                el("tr",{},[
                  el("td",{colspan:"9", class:"empty", text:"é–‹ãã¨èª­ã¿è¾¼ã¿ã¾ã™ğŸ’¿"})
                ])
              ])
            ])
          ]),

          el("div",{class:"recvList", id:`cards-${d.date}`},[
            el("div",{class:"empty", text:"é–‹ãã¨èª­ã¿è¾¼ã¿ã¾ã™ğŸ’¿"})
          ]),

          el("div",{id:`memo-${d.date}`})
        ])
      );
    }

    const body = el("div",{class:"dayBody", id:`body-${d.date}`}, bodyKids);

    det.appendChild(sum);
    det.appendChild(body);

    det.addEventListener("toggle", async ()=>{
      if(!det.open) return;
      if(locked){ det.open = false; return; }
      if(!hasData) return;
      await loadDay(det, d.date);
    });

    $("#dayList").appendChild(det);
  }
}

/* ========= ä¸¦ã³æ›¿ãˆ ========= */
function setDayOrder(date, mode){
  state.dayOrder[date] = mode;
  const bin = document.getElementById(`ord-in-${date}`);
  const bout = document.getElementById(`ord-out-${date}`);
  if(bin && bout){
    bin.classList.toggle("on", mode === "in");
    bout.classList.toggle("on", mode === "out");
  }
  if(state.dayCache[date]) renderDayFromCache(date);
}

/* ========= day parts ========= */
function renderDayMemo(date, note){
  const box = document.getElementById(`memo-${date}`);
  if(!box) return;
  box.innerHTML = "";
  const s = (note ?? "").toString().trim();
  if(!s) return;
  box.appendChild(el("div",{class:"memoFull", text:`ğŸ“ ${s}`}));
}
function renderBarStats(date, pills){
  const box = document.getElementById(`barstats-${date}`);
  if(!box) return;
  box.innerHTML = "";
  for(const t of (pills || [])) box.appendChild(el("div",{class:"pill", text:t}));
}

/* ========= build list (filter + sort) ========= */
function filteredSortedGroups(groups, bizDate){
  const q = (state.q || "").trim().toLowerCase();
  let list = (groups||[]).filter(g=>{
    if(!q) return true;
    try{ return JSON.stringify(g).toLowerCase().includes(q); }
    catch{ return true; }
  });

  const mode = state.dayOrder[bizDate] || "in";
  list.sort((a,b)=>{
    const aIn = Date.parse(a.checkInAt||"");
    const bIn = Date.parse(b.checkInAt||"");
    const aOut = a.checkOutAt ? Date.parse(a.checkOutAt) : NaN;
    const bOut = b.checkOutAt ? Date.parse(b.checkOutAt) : NaN;

    if(mode === "in") return (isNaN(aIn)?0:aIn) - (isNaN(bIn)?0:bIn);

    const aKey = !isNaN(aOut) ? aOut : (isNaN(aIn)?0:aIn);
    const bKey = !isNaN(bOut) ? bOut : (isNaN(bIn)?0:bIn);
    return aKey - bKey;
  });

  return list;
}

/* ========= desktop table rows ========= */
function buildTableRows(groups, bizDate){
  const list = filteredSortedGroups(groups, bizDate);

  let cumPeople = 0;

  return list.map((g, idx)=>{
    const p = Number(g.partySize||0);
    cumPeople += p;

    const seats = String(g.primarySeat || "");
    const lbl = guestTypeLabel(g.guestType);
    const kbnClass = guestTypeClass(g.guestType);
    const kbnIcon  = (lbl==="æ–°è¦") ? "ğŸ†•" : (lbl==="ãƒªãƒ”") ? "ğŸ”" : "âœ¨";

    const inT  = fmtTime(g.checkInAt);
    const outT = g.checkOutAt ? fmtTime(g.checkOutAt) : "-";

    const ex = extendBreakdown(g);
    const exText = ex.parts.length ? `${ex.parts.join("  ")} ï½œ åˆè¨ˆ${ex.total}åˆ†` : "ãªã—";

    return el("tr",{},[
      el("td",{ "data-label":"No", text:String(idx+1) }),
      el("td",{ "data-label":"ç´¯è¨ˆ", text:String(cumPeople) }),
      el("td",{ "data-label":"å“ç•ª", text:seats }),
      el("td",{ "data-label":"åŒºåˆ†" },[
        el("span",{ class:`kbn ${kbnClass}`, text:`${kbnIcon} ${lbl}` })
      ]),
      el("td",{ "data-label":"ãŠå®¢æ§˜å", text:String(g.name||"") }),
      el("td",{ "data-label":"äººæ•°", text:String(p||"") }),
      el("td",{ "data-label":"å…¥åº—", text:inT }),
      el("td",{ "data-label":"é€€åº—", text:outT }),
      el("td",{ "data-label":"å»¶é•·", text:exText })
    ]);
  });
}

/* ========= mobile cards ========= */
function buildRecvCards(groups, bizDate){
  const list = filteredSortedGroups(groups, bizDate);
  let cumPeople = 0;

  return list.map((g, idx)=>{
    const p = Number(g.partySize||0);
    cumPeople += p;

    const seats = String(g.primarySeat || "");
    const lbl = guestTypeLabel(g.guestType);

    const inT  = fmtTime(g.checkInAt);
    const outT = g.checkOutAt ? fmtTime(g.checkOutAt) : "-";

    const ex = extendBreakdown(g);
    const exText = ex.parts.length ? `${ex.parts.join("  ")} ï½œ åˆè¨ˆ${ex.total}åˆ†` : "ãªã—";

    const card = el("div",{class:"recvCard"},[
      /* Row 1: No / ç´¯è¨ˆ */
      el("div",{class:"recvRow"},[
        el("div",{class:"recvCell isLabel", text:"No"}),
        el("div",{class:"recvCell isVal", text:String(idx+1)}),
        el("div",{class:"recvCell isLabel", text:"ç´¯è¨ˆ"}),
        el("div",{class:"recvCell isVal", text:String(cumPeople)}),
      ]),

      /* Row 2: å“ç•ª / äººæ•° */
      el("div",{class:"recvRow"},[
        el("div",{class:"recvCell isLabel", text:"å“ç•ª"}),
        el("div",{class:"recvCell isVal", text:seats || "-"}),
        el("div",{class:"recvCell isLabel", text:"äººæ•°"}),
        el("div",{class:"recvCell isVal", text:String(p||"-")}),
      ]),

      /* Row 3: åŒºåˆ†(2ãƒã‚¹) + ãŠåå‰(1:3) */
      el("div",{class:"recvRow kbnName"},[
        el("div",{class:"recvCell isLabel", text:"åŒºåˆ†"}),
        el("div",{class:"recvCell isVal"},[
          el("span",{class:"kbnBadge", "data-kbn": lbl, text: lbl })
        ]),
        el("div",{class:"recvCell isLabel", text:"ãŠåå‰"}),
        el("div",{class:"recvCell isVal left", text:String(g.name||"") || "-"}),
      ]),

      /* Row 4: å…¥åº— / é€€åº— */
      el("div",{class:"recvRow"},[
        el("div",{class:"recvCell isLabel", text:"å…¥åº—"}),
        el("div",{class:"recvCell isVal", text:inT}),
        el("div",{class:"recvCell isLabel", text:"é€€åº—"}),
        el("div",{class:"recvCell isVal", text:outT}),
      ]),

      /* Row 5: å»¶é•·ï¼ˆé•·ã„ã®ã§1:3ã¶ã¡æŠœãï¼‰ */
      el("div",{class:"recvRow long"},[
        el("div",{class:"recvCell isLabel", text:"å»¶é•·"}),
        el("div",{class:"recvCell isVal", text:exText}),
        el("div",{class:"recvCell isLabel", text:""}),
        el("div",{class:"recvCell isVal", text:""}),
      ]),
    ]);

    return card;
  });
}

/* ========= render day from cache (TABLE ONLY) ========= */
function renderDayFromCache(bizDate){
  const cache = state.dayCache[bizDate];
  if(!cache) return;

  const groups = cache.groups || [];

  // ---- table only ----
  const tb = document.getElementById(`tb-${bizDate}`);
  if(tb){
    tb.innerHTML = "";

    const rows = buildTableRows(groups, bizDate);
    if(rows.length === 0){
      tb.appendChild(el("tr",{},[
        el("td",{colspan:"9", class:"empty", text:"æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ğŸ¬"})
      ]));
    }else{
      for(const tr of rows) tb.appendChild(tr);
    }
  }

  // ---- cards area is deprecated ----
  const cards = document.getElementById(`cards-${bizDate}`);
  if(cards){
    cards.innerHTML = ""; // ä½•ã‚‚å‡ºã•ãªã„ï¼ˆæ³¨æ„æ–‡ã‚‚å‡ºã•ãªã„ï¼‰
  }
}

/* ========= load day ========= */
async function loadDay(det, bizDate){
  const cacheKey = CACHE_PREFIX + bizDate;
  if(det?.dataset?.loading === "1") return;
  if(det) det.dataset.loading = "1";

  const tb = document.getElementById(`tb-${bizDate}`);
  if(tb){
    tb.innerHTML = "";
    tb.appendChild(el("tr",{},[
      el("td",{colspan:"9", class:"empty", text:"èª­ã¿è¾¼ã¿ä¸­â€¦ğŸ’¿"})
    ]));
  }

  const cards = document.getElementById(`cards-${bizDate}`);
  if(cards){
    cards.innerHTML = "";
    cards.appendChild(el("div",{class:"empty", text:"èª­ã¿è¾¼ã¿ä¸­â€¦ğŸ’¿"}));
  }

  try{
    let data = cacheGet(cacheKey);
    if(!data){
      data = await fetchJSON(ENDPOINTS.day(bizDate));
      cacheSet(cacheKey, data);
    }

    const groups = (data && data.groups) ? data.groups : [];
    const st = calcStats(groups);
    const pills = statPills(st);

    const dayInfo = state.days.find(x=>x.date === bizDate);
    const note = dayInfo ? (dayInfo.note ?? "") : "";

    state.dayCache[bizDate] = { groups, stats: st, pills, note };

    renderBarStats(bizDate, pills);
    renderDayFromCache(bizDate);
    renderDayMemo(bizDate, note);

  }catch(e){
    if(tb){
      tb.innerHTML = "";
      tb.appendChild(el("tr",{},[
        el("td",{colspan:"9", class:"empty", text:`èª­ã¿è¾¼ã¿å¤±æ•—â€¦ğŸ¥²ï¼ˆ${e.message}ï¼‰`})
      ]));
    }
    if(cards){
      cards.innerHTML = "";
      cards.appendChild(el("div",{class:"empty", text:`èª­ã¿è¾¼ã¿å¤±æ•—â€¦ğŸ¥²ï¼ˆ${e.message}ï¼‰`}));
    }
    console.error("loadDay failed", bizDate, e);
  }finally{
    if(det) det.dataset.loading = "0";
  }
}

/* ========= month stats ========= */
function addStats(a,b){
  for(const k of Object.keys(emptyStats())){
    a[k] = (a[k]||0) + (b[k]||0);
  }
  return a;
}

async function buildMonthStats(){
  const dates = state.days.filter(d=>Number(d.count||0)>0).map(d=>d.date);
  if(dates.length===0){
    state.monthStats = emptyStats();
    $("#monthStatPill").textContent = "æœˆçµ±è¨ˆ:ãƒ‡ãƒ¼ã‚¿ãªã—";
    $("#monthBarLeft").textContent = "ä»Šæœˆã¯ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  setStatus("æœˆçµ±è¨ˆ é›†è¨ˆä¸­â€¦");
  $("#monthBarLeft").textContent = `é›†è¨ˆä¸­â€¦ 0/${dates.length}æ—¥`;

  let total = emptyStats();
  let done = 0;

  const CONCURRENCY = 5;
  const queue = dates.slice();

  async function worker(){
    while(queue.length){
      const d = queue.shift();
      const cacheKey = CACHE_PREFIX + d;
      try{
        let data = cacheGet(cacheKey);
        if(!data){
          data = await fetchJSON(ENDPOINTS.day(d));
          cacheSet(cacheKey, data);
        }
        const groups = (data && data.groups) ? data.groups : [];
        total = addStats(total, calcStats(groups));
      }catch(e){
        console.warn("monthStats day failed:", d, e);
      }
      done++;
      $("#monthBarLeft").textContent = `é›†è¨ˆä¸­â€¦ ${done}/${dates.length}æ—¥`;
    }
  }

  await Promise.all(Array.from({length:CONCURRENCY}, ()=>worker()));
  state.monthStats = total;

  const extRate = total.groupsTotal ? Math.round(total.extendedGroups/total.groupsTotal*100) : 0;
  const avgStay = total.staySamples ? Math.round(total.stayMinutesTotal/total.staySamples) : 0;

  // ãƒ‡ãƒ¼ã‚¿æ—¥ã‚ãŸã‚Šå¹³å‡ï¼ˆçµ„ / åï¼‰
  const dataDays = dates.length;
  const avgGroups = (dataDays > 0) ? (total.groupsTotal / dataDays) : 0;
  const avgPeople = (dataDays > 0) ? (total.peopleTotal / dataDays) : 0;

  const fmt1 = (x)=>{
    const v = Math.round(x * 10) / 10;
    return (v % 1 === 0) ? String(v.toFixed(0)) : String(v.toFixed(1));
  };

  $("#monthStatPill").textContent =
    `ã€åˆè¨ˆ:${total.groupsTotal}çµ„${total.peopleTotal}åã€‘ã€å¹³å‡/æ—¥:${fmt1(avgGroups)}çµ„${fmt1(avgPeople)}åã€‘`;

  $("#monthBarLeft").textContent =
    ` æ–°è¦ ${total.groupsNew}çµ„${total.peopleNew}å` +
    ` ï½œ ãƒªãƒ” ${total.groupsRepeat}çµ„${total.peopleRepeat}å` +
    ` ï½œ å»¶é•·ç‡ ${extRate}% ï½œ å¹³å‡æ»åœ¨ ${avgStay}åˆ†`;

  setStatus("OK");
}

/* ========= navigation ========= */
function scrollToDate(ds){
  const det = document.querySelector(`details.day[data-date="${ds}"]`);
  if(!det) return;
  det.scrollIntoView({behavior:"smooth", block:"start"});
}
function jumpToLatest(){
  const d = state.latestWithData;
  if(d){
    scrollToDate(d);
    const det = document.querySelector(`details.day[data-date="${d}"]`);
    if(det) det.open = true;
  }else{
    scrollToDate(dateStr(state.ym,1));
  }
}
function refreshOpenDays(){
  document.querySelectorAll('details.day[open]').forEach(det=>{
    const date = det.getAttribute("data-date");
    const dayInfo = state.days.find(x=>x.date===date);
    const hasData = !!(dayInfo && Number(dayInfo.count||0)>0);
    if(!hasData) return;

    if(state.dayCache[date]) renderDayFromCache(date);
    else loadDay(det, date);
  });
}

/* ========= load month ========= */
async function loadMonth(){
  setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
  $("#monthSearchPill").textContent = state.q ? `æ¤œç´¢:${state.q}` : "æ¤œç´¢:ãªã—";
  state.latestWithData = null;

  const data = await fetchJSON(ENDPOINTS.month(state.ym));
  state.days = (data && data.days) ? data.days : [];

  state.dayCache = {};
  state.dayOrder = {};

  for(const d of state.days){
    if(Number(d.count||0)>0 && (!state.latestWithData || d.date > state.latestWithData)){
      state.latestWithData = d.date;
    }
  }

  renderMonth();
  setStatus("OK");
}

/* ========= init ========= */
(function init(){
  const initYM = toYM(new Date());
  state.ym = initYM;

  const mp = $("#monthPicker");
  mp.value = initYM;

  $("#q").value = "";

  mp.addEventListener("change", ()=>{
    state.ym = mp.value || toYM(new Date());
    loadMonth().catch(showFatal);
  });

  $("#q").addEventListener("input", (e)=>{
    state.q = e.target.value.trim();
    $("#monthSearchPill").textContent = state.q ? `æ¤œç´¢:${state.q}` : "æ¤œç´¢:ãªã—";
    refreshOpenDays();
  });

  $("#btnReload").addEventListener("click", ()=>loadMonth().catch(showFatal));
  $("#btnJumpLatest").addEventListener("click", jumpToLatest);

  $("#btnCollapseAll").addEventListener("click", ()=>{
    document.querySelectorAll("details.day[open]").forEach(d=>d.open=false);
  });

  $("#btnExpandWithData").addEventListener("click", ()=>{
    document.querySelectorAll("details.day").forEach(det=>{
      const date=det.getAttribute("data-date");
      const dayInfo = state.days.find(x=>x.date===date);
      det.open = !!(dayInfo && Number(dayInfo.count||0)>0);
    });
  });

  $("#btnBuildMonthStats").addEventListener("click", ()=>buildMonthStats().catch(console.warn));

  // ç”»é¢ã‚µã‚¤ã‚ºåˆ‡æ›¿ã§ã€é–‹ã„ã¦ã‚‹æ—¥ã‚’å†æç”»ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«â‡”ã‚«ãƒ¼ãƒ‰ï¼‰
  window.addEventListener("resize", ()=>{
    refreshOpenDays();
  });

  loadMonth().catch(showFatal);
})();
</script>
</body>
</html>
